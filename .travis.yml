sudo: false

#group: deprecated-2017Q4

language: node_js
node_js:
  - '11'
#dist: xenial #try new build env, did not work 
addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-7
  chrome: stable

branches:
  only:
    - develop

before_cache:
  - rm -f $HOME/.meteor/log/*.log

cache:
  yarn: true
  directories:
    - $HOME/.meteor

services:
  - docker

before_install:
#update to the latest version of yarn to support package-lock.json
  - curl -o- -L https://yarnpkg.com/install.sh | bash
  - export PATH="$HOME/.yarn/bin:$PATH"
  #- yarn import
  - free -m
  - pwd
  - ls -la
  - g++ --version
  # Install meteor locally on CI
  - if [ ! -e "$HOME/.meteor/meteor" ]; then cat .travis_install_meteor | sed s/--progress-bar/-sL/g | /bin/sh; fi


before_script:
  - yarn
  - yarn run lint
  - npm view chimp version
  - npm view chromedriver version  
  # Start X Virtual Frame Buffer for headless testing with real browsers
  - ./.scripts/start-xvfb.sh

install:
  - export PATH="$HOME/.meteor:$PATH"

script:
  # Run meteor and chimp from node.js
  - travis_retry yarn test
  # Build docker image
  - ./.scripts/docker_build.sh

env:
  global:
  - DISPLAY=:99.0
  - TEST_MODE: "true"
  - CXX=g++-7
